# op for iOS

## Prerequisites

### Software

- [Xcode](https://developer.apple.com/xcode/resources/)
- [Configurator 2](https://apps.apple.com/us/app/apple-configurator-2/id1037126344?mt=12) (Optional)

### Administravia

To run software on iOS, it must be signed by Xcode using the certificate data
contained in a "Provisioning Profile". This is a file generated by Apple and it
links `app identity`, `certificates` (used for code signing), `app permissions`,
and phystical `devices`.

#### Setup

1. Sign up for a (free) [Apple Developer][https://developer.apple.com/] account.
2. Register your [devices][01] for testing.
3. Create an [app id][A2] for the application you are developing.
4. Create an [App Store Connect][A3] record for your app (don't worry about
filling in all the details yet, it just needs to exist).

#### Certificates

1. Create a [iOS Development][A4] certificate for running the app on your
device while developing.

2. Create an [iOS Distribution (App Store and Ad Hoc)][A4] certificate if you
want to distribute copies for other people on your team.

3. Download the certificates, put them somewhere, select both and double click
them to install to the `Apple Keychain`.

#### Provisioning Profiles

1. Create a provisioning profile for `Development` (build and deploy to your
iphone). Include the certificate for `iOS Development`.

2. Create a profile for `Ad-Hoc` distribution (give other people copies that
they can install). Include the devices you want to deploy to and include the
certificate you created for `iOS Distribution`.

3. Download the profiles and add them to your project. They are
secret, don't commit them, add the appropriate file names to your `.gitignore`
file. op will pick the right one for you based on your build flags.

### Configuration

Edit the following fields in the `operator.config` file of your project.

```settings
apple_teamId: Z3M838H537
apple_debug_distribution_method: ad-hoc
apple_debug_signing_certificate: iOS Distribution (App Store and Ad Hoc)
apple_debug_provisioning_profile: src/development.mobileprovision

apple_release_distribution_method: ad-hoc
apple_release_signing_certificate: iOS Distribution (App Store and Ad Hoc)
apple_release_provisioning_profile: src/distribution.mobileprovision
```

```bash
op . -r # start the simulator
```

```bash
op . -ios -c -p -xd # package for distribution
```

## Distribution

### Your Device

Connect your device, open the the `Apple Configurator 2` app and drag
the inner `{{name}}.ipa` file onto your phone.


### Apple App Store

```bash
xcrun altool --validate-app \
  -f file \
  -t platform \
  -u username [-p password] \
  [--output-format xml]
```

```bash
xcrun altool --upload-app \
  -f file \
  -t platform \
  -u username [-p password] \
  [â€”output-format xml]
```

## Development

### Running the iOS Simulator
To create a iOS VM.

```bash
xcrun simctl \
  create <YourSimulatorDeviceName> \
  com.apple.CoreSimulator.SimDeviceType.iPhone-13-Pro \
  com.apple.CoreSimulator.SimRuntime.iOS-15-0 > boot-id.txt
```

To boot the VM that was created from the command above.

```bash
xcrun simctl boot `cat boot-id.txt`
```

To run the simulator.

```bash
open /Applications/Xcode.app/Contents/Developer/Applications/Simulator.app/
```

To install your app into the current VM of the running simulator.

```bash
xcrun simctl install booted test/ios/dist/TestExample-dev.app
```

## Debugging

You can run [`lldb`][1] and attach to a process, for example...

```bash
process attach --name TestExample-dev
```

### Logging

To see logs, open `Console.app` (installed on MacOS by default) and in the
right side panel pick <YourSimulatorDeviceName>. You can filter by `op`
to see the logs that your app outputs.

###  Loading your app onto a real phone.

[A0]:https://developer.apple.com
[A1]:https://developer.apple.com/account/resources/devices/add
[A2]:https://developer.apple.com/account/resources/identifiers
[A3]:https://appstoreconnect.apple.com/apps
[A4]:https://developer.apple.com/account/resources/profiles/add
[A5]:https://developer.apple.com/account/resources/certificates/add
[1]:https://developer.apple.com/library/archive/documentation/IDEs/Conceptual/gdb_to_lldb_transition_guide/document/lldb-terminal-workflow-tutorial.html
